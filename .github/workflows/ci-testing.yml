name: CI - Test, Build & Push (testing)

on:
  push:
    branches: [ testing ]

env:
  ACR_NAME: nareshacr10d
  ACR_LOGIN_SERVER: nareshacr10d.azurecr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  tests:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        service:
          - task10_2d/backend/customer_service
          - task10_2d/backend/order_service
          - task10_2d/backend/product_service
          - task10_2d/frontend
    steps:
      - uses: actions/checkout@v4

      # ---- Backend (Python) ----
      - name: Set up Python
        if: startsWith(matrix.service, 'task10_2d/backend/')
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (backend)
        if: startsWith(matrix.service, 'task10_2d/backend/')
        run: |
          if [ -f "${{ matrix.service }}/requirements-dev.txt" ]; then
            pip install -r "${{ matrix.service }}/requirements-dev.txt" || true
          fi

      - name: Run tests (backend)
        if: startsWith(matrix.service, 'task10_2d/backend/')
        run: |
          if [ -d "${{ matrix.service }}/tests" ]; then
            pytest -q "${{ matrix.service }}/tests" || true
          fi

      # ---- Frontend (Node) ----
      - name: Set up Node
        if: matrix.service == 'task10_2d/frontend'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Frontend build check
        if: matrix.service == 'task10_2d/frontend'
        run: |
          cd task10_2d/frontend || exit 0
          if [ -f package-lock.json ]; then
            npm ci || true
          else
            npm install || true
          fi
          npm run build || true

  build_and_push:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (service principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login
        run: az acr login --name $ACR_NAME

      - name: Build images
        run: |
          docker build -t $ACR_LOGIN_SERVER/customer-service:${IMAGE_TAG} task10_2d/backend/customer_service
          docker build -t $ACR_LOGIN_SERVER/order-service:${IMAGE_TAG}    task10_2d/backend/order_service
          docker build -t $ACR_LOGIN_SERVER/product-service:${IMAGE_TAG}  task10_2d/backend/product_service
          docker build -t $ACR_LOGIN_SERVER/frontend:${IMAGE_TAG}         task10_2d/frontend

      - name: Push images
        run: |
          docker push $ACR_LOGIN_SERVER/customer-service:${IMAGE_TAG}
          docker push $ACR_LOGIN_SERVER/order-service:${IMAGE_TAG}
          docker push $ACR_LOGIN_SERVER/product-service:${IMAGE_TAG}
          docker push $ACR_LOGIN_SERVER/frontend:${IMAGE_TAG}
